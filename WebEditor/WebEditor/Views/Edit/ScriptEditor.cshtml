@model WebEditor.Models.Script
@using AxeSoftware.Quest

@RenderScripts(Model.Scripts, Model.Attribute)

@helper RenderScripts(IEditableScripts scripts, string attribute)
{
    <div class="ui-widget-header ui-corner-all toolbar">
        <button type="button" class="script-add" data-key="@attribute">Add new script</button>
        <button type="button" class="script-delete" data-key="@attribute">Delete</button>
    </div>

    <div>
        @{
            if (scripts != null) {
                int count = 0;
                foreach (IEditableScript script in scripts.Scripts)
                {
                    IEditorDefinition definition = Model.Controller.GetEditorDefinition(script);
                    <div>
                        @Html.CheckBox("selected-" + attribute + "-" + count.ToString(), new { @class = "script-select" })
                        @if (script.Type != ScriptType.If)
                        {
                            foreach (IEditorControl ctl in definition.Controls)
                            {
                                if (ctl.GetBool("breakbefore"))
                                {
                                    <br /><text>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</text>
                                }
                                else
                                {
                                    <text> </text>
                                }
                                object value = ctl.Attribute == null ? null : script.GetParameter(ctl.Attribute);
                                @RenderEditorControl(ctl, value, attribute + "-" + count.ToString())
                            }
                        }
                        else
                        {
                            @RenderIfScript((EditableIfScript)script, attribute + "-" + count.ToString())
                        }
                    </div>
                    count++;
                }
            }
        }
    </div>
}

@helper RenderEditorControl(IEditorControl ctl, object value, string attributePrefix)
{
    string name = attributePrefix + "-" + ctl.Attribute;
    switch (ctl.ControlType)
    {
        case "checkbox":
            @Html.CheckBox(name, value as bool? == true)
            @Html.Label(name, ctl.Caption)
            break;
        case "textbox":
            @Html.TextBox(name, (string)value)
            break;
        case "label":
            @ctl.Caption
            break;
        case "dropdown":
            //Code from ElementEditor.cshtml should be shared
            break;
        case "expression":
            // TO DO: Implement simpleeditor
            @Html.TextBox(name, (string)value, new { style = "width: 350px" })
            break;
        default:
            <text>[@ctl.ControlType]</text>
            break;
    }
}

@helper RenderIfScript(EditableIfScript script, string attributePrefix)
{
    <text>If: </text>
    // TO DO: This needs to use the same expression mechanism as RenderEditorControl
    @Html.TextBox(attributePrefix + "-expression", script.GetAttribute("expression"), new { style = "width: 350px" })
    <div class="childScript">
    @RenderScripts(script.ThenScript, attributePrefix + "-then")
    </div>
    
    <div class="ifSection ui-widget-header ui-corner-all toolbar" id="ifsection-toolbar-@attributePrefix" style="display: none">
        <button type="button" class="ifsection-delete" data-key="@attributePrefix">Remove section</button>
    </div>
    
    int elseIfCount = 0;
    foreach (EditableIfScript.EditableElseIf elseIf in script.ElseIfScripts)
    {
        // TO DO: This needs to use the same expression mechanism as RenderEditorControl
        <div class="ifSection">
        @Html.CheckBox("selectifsection-" + attributePrefix + "-elseif" + elseIfCount.ToString(), new { @class = "ifsection-select", data_key = attributePrefix })
        Else If:
        @Html.TextBox(attributePrefix + "-elseif" + elseIfCount.ToString() + "-expression", elseIf.GetAttribute("expression"), new { style = "width: 350px" })
        </div>
        <div class="childScript">
        @RenderScripts(elseIf.EditableScripts, attributePrefix + "-elseif" + elseIfCount.ToString())
        </div>

        elseIfCount++;
    }
    
    <div class="ifSection"><button type="button" class="script-if-add-elseif" data-key="@attributePrefix">Add Else If</button></div>

    if (script.ElseScript == null)
    {
        <div class="ifSection">
        <button type="button" class="script-if-add-else" data-key="@attributePrefix">Add Else</button>
        </div>
    }
    else
    {
        <div class="ifSection">
        @Html.CheckBox("selectifsection-" + attributePrefix + "-else", new { @class = "ifsection-select", data_key = attributePrefix })
        Else:
        </div>
        <div class="childScript">
        @RenderScripts(script.ElseScript, attributePrefix + "-else")
        </div>
    }
}